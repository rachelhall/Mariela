---
import Header from "../components/Header.astro";
import Layout from "../layouts/Layout.astro";
import Bio from "../components/Bio.astro";
import TourHistory from "../components/TourHistory.astro";
import Watch from "../components/Watch.astro";
import Press from "../components/Press.astro";
import Listen from "../components/Listen.astro";
import Contact from "../components/Contact.astro";
import Gallery from "../components/Gallery.astro";

const CLOUDINARY_FOLDER_PATH = "44k24"; // update to your folder

const CLOUDINARY_CLOUD_NAME = import.meta.env.CLOUDINARY_CLOUD_NAME;
const CLOUDINARY_API_KEY = import.meta.env.CLOUDINARY_API_KEY;
const CLOUDINARY_API_SECRET = import.meta.env.CLOUDINARY_API_SECRET;

type CloudinaryResource = { secure_url?: string };

const fetchCloudinaryUrls = async () => {
  console.log("fetching...");
  if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_API_KEY || !CLOUDINARY_API_SECRET) {
    console.warn(
      "Cloudinary env vars missing. Skipping Cloudinary Search on EPK page."
    );
    return [];
  }

  const urls: string[] = [];
  const searchUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/resources/search`;
  const expression = `folder="${CLOUDINARY_FOLDER_PATH}"`;
  let next_cursor: string | undefined;

  try {
    do {
      const res = await fetch(searchUrl, {
        method: "POST",
        headers: {
          Authorization: `Basic ${Buffer.from(`${CLOUDINARY_API_KEY}:${CLOUDINARY_API_SECRET}`).toString("base64")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          expression,
          max_results: 500,
          ...(next_cursor ? { next_cursor } : {}),
        }),
      });

      if (!res.ok) {
        const text = await res.text();
        console.error("Cloudinary search error:", res.status, text);
        break;
      }

      const data = (await res.json()) as {
        resources?: CloudinaryResource[];
        next_cursor?: string;
      };

      const batch =
        data.resources
          ?.map((asset) => asset.secure_url)
          .filter((url): url is string => Boolean(url)) ?? [];
      urls.push(...batch);
      next_cursor = data.next_cursor;
    } while (next_cursor);

    console.log({
      folder: CLOUDINARY_FOLDER_PATH,
      count: urls.length,
      urls,
    });
  } catch (error) {
    console.error("Cloudinary search failed:", error);
  }

  return urls;
};

await fetchCloudinaryUrls();
---

<Layout title="Mariela - EPK">
  <main>
    <div class="epk">
      <Header
        page="epk"
        heading="A Note From Mariela"
        quote={`I’m not out here, just trying to play shows and pay my rent. I want to play for the people who are desperate to see trans and queer joy, freedom, and healing. Every time I step on stage or release a record, I want to connect with that young person in the crowd, me from 5 years ago, who is still trying to believe they belong, that they are worthy of love. I’m looking for the music industry’s big players like managers, bookers, labels, etc. with the resources and network to help me make those connections happen on a larger scale. When trans artists have the opportunity to share, we remind everyone what authenticity and inclusion truly look and sound like.`}
        author="- Mariela"
      />
      <Listen />
      <Bio />
      <Gallery />
      <!-- <SocialMediaStats /> -->
      <Press />
      <Watch />
      <TourHistory />
      <Contact />
    </div>
  </main>
</Layout>
<style>
  .epk {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    background-color: var(--primary-500);
  }
</style>
